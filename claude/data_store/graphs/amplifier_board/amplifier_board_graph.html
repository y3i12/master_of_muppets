<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Amplifier Board - Circuit Graph</title>
    <!-- 
    CORS Notice: If opening this file directly (file:// protocol), 
    fetch requests will be blocked by browser security.
    
    To run properly with full PCB data:
    1. From project root, run: python -m http.server 8000
    2. Or use: npx http-server -p 8000  
    3. Then open: http://localhost:8000/claude/data_store/graphs/amplifier_board/amplifier_board_graph.html
    
    Fallback data is embedded for direct file opening.
    -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cytoscape/3.26.0/cytoscape.min.js"></script>
    <style>
        body {
            margin: 0;
            padding: 0;
            font-family: Arial, sans-serif;
            background: #1a1a1a;
            color: #fff;
        }
        #cy {
            width: 100%;
            height: 100vh;
            background: #2a2a2a;
        }
        .controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }
        .controls h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .controls button {
            display: block;
            margin: 5px 0;
            padding: 8px 15px;
            background: #4CAF50;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            width: 150px;
        }
        .controls button:hover {
            background: #45a049;
        }
        .legend {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 8px;
            z-index: 1000;
        }
        .legend h3 {
            margin: 0 0 10px 0;
            color: #4CAF50;
        }
        .legend-item {
            margin: 5px 0;
            display: flex;
            align-items: center;
        }
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 10px;
            border-radius: 50%;
        }
    </style>
</head>
<body>
    <div id="cy"></div>
    
    <div class="controls">
        <h3>Amplifier Board Graph</h3>
        <button onclick="fitToScreen()">Fit to Screen</button>
        <button onclick="toggleLabels()">Toggle Labels</button>
        <button id="physicsToggle" onclick="togglePhysicsButton()">Start Physics</button>
        
        <div style="margin-top: 15px;">
            <label style="color: #ccc; font-size: 12px;">Edge Length:</label>
            <input type="range" id="edgeLength" min="50" max="300" value="120" 
                   style="width: 120px; margin: 5px 0;" onchange="updatePhysics()">
            <span id="edgeLengthValue" style="color: #ccc; font-size: 11px;">120</span>
        </div>
        
        <div>
            <label style="color: #ccc; font-size: 12px;">Repulsion:</label>
            <input type="range" id="repulsion" min="100000" max="2000000" value="800000" 
                   style="width: 120px; margin: 5px 0;" onchange="updatePhysics()">
            <span id="repulsionValue" style="color: #ccc; font-size: 11px;">800k</span>
        </div>
        
        <div>
            <label style="color: #ccc; font-size: 12px;">Gravity:</label>
            <input type="range" id="gravity" min="1" max="50" value="5" 
                   style="width: 120px; margin: 5px 0;" onchange="updatePhysics()">
            <span id="gravityValue" style="color: #ccc; font-size: 11px;">5</span>
        </div>
        
        <div>
            <label style="color: #ccc; font-size: 12px;">Damping:</label>
            <input type="range" id="damping" min="0.5" max="0.99" value="0.85" step="0.01"
                   style="width: 120px; margin: 5px 0;" onchange="updatePhysics()">
            <span id="dampingValue" style="color: #ccc; font-size: 11px;">0.85</span>
        </div>
        
        <div>
            <label style="color: #ccc; font-size: 12px;">Speed:</label>
            <input type="range" id="speed" min="0.1" max="2.0" value="1.0" step="0.1"
                   style="width: 120px; margin: 5px 0;" onchange="updatePhysics()">
            <span id="speedValue" style="color: #ccc; font-size: 11px;">1.0x</span>
        </div>
        
        <div>
            <label style="color: #ccc; font-size: 12px;">Repulsion Range:</label>
            <input type="range" id="repulsionRange" min="50" max="300" value="150" 
                   style="width: 120px; margin: 5px 0;" onchange="updatePhysics()">
            <span id="repulsionRangeValue" style="color: #ccc; font-size: 11px;">150</span>
        </div>
        
        <div>
            <label style="color: #ccc; font-size: 12px;">Gravity Range:</label>
            <input type="range" id="gravityRange" min="100" max="500" value="250" 
                   style="width: 120px; margin: 5px 0;" onchange="updatePhysics()">
            <span id="gravityRangeValue" style="color: #ccc; font-size: 11px;">250</span>
        </div>
    </div>
    
    <div class="legend">
        <h3>Component Types</h3>
        <div class="legend-item">
            <div class="legend-color" style="background: #FF6B6B;"></div>
            <span>Transistor</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FFA500;"></div>
            <span>Resistor</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #9370DB;"></div>
            <span>Capacitor</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #4CAF50;"></div>
            <span>Connector</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #FFD700;"></div>
            <span>Power</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #8B4513;"></div>
            <span>Ground</span>
        </div>
        <div class="legend-item">
            <div class="legend-color" style="background: #87CEEB;"></div>
            <span>Switch</span>
        </div>
    </div>
    
    <script>
        // Graph data will be loaded from PCB JSON
        const graphData = {
            nodes: [],
            edges: []
        };

        // Function to load all PCB data in one request
        async function loadPCBData() {
            try {
                // Check if we're running from file:// protocol
                if (window.location.protocol === 'file:') {
                    console.warn('Running from file:// protocol. CORS will block fetch requests.');
                    console.warn('To fix this, either:');
                    console.warn('1. Run: python -m http.server 8000 (from the project root)');
                    console.warn('2. Or use: npx http-server -p 8000');
                    console.warn('3. Then open: http://localhost:8000/claude/data_store/graphs/amplifier_board/amplifier_board_graph.html');
                    
                    // Return fallback data for file:// protocol
                    return getFallbackPCBData();
                }
                
                const response = await fetch('../../pcb/amplifier_board/complete_project/AmpBoard.json');
                const pcbData = await response.json();
                return pcbData;
            } catch (error) {
                console.error('Error loading PCB AmpBoard.json:', error);
                console.warn('Falling back to embedded data...');
                return getFallbackPCBData();
            }
        }

        // Fallback PCB data when fetch fails (extracted key data from AmpBoard.json)
        function getFallbackPCBData() {
            return {
                computed_info: {
                    footprint_positions: [
                        {"reference": "POW0", "x": 81.28, "y": -68.58, "rotation": 0, "entry_name": "WEIDMULLER_PM5.08_2", "library_reference": "Connector_Phoenix_MSTB"},
                        {"reference": "R10", "x": 193.04, "y": -104.14, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "R1", "x": 116.84, "y": -81.28, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "OUT0", "x": 213.36, "y": -111.76, "rotation": 0, "entry_name": "WEIDMULLER_PM5.08_2", "library_reference": "Connector_Phoenix_MSTB"},
                        {"reference": "C7", "x": 185.42, "y": -101.6, "rotation": 0, "entry_name": "E3,5-8_420", "library_reference": "Capacitor_THT"},
                        {"reference": "C3", "x": 127, "y": -124.46, "rotation": 0, "entry_name": "E2-5_420", "library_reference": "Capacitor_THT"},
                        {"reference": "Q2", "x": 190.5, "y": -81.28, "rotation": 0, "entry_name": "TO126AV_400", "library_reference": "Package_TO_SOT_THT"},
                        {"reference": "R5", "x": 147.32, "y": -73.66, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "Q1", "x": 137.16, "y": -111.76, "rotation": 0, "entry_name": "TO92-EBC_399", "library_reference": "Package_TO_SOT_THT"},
                        {"reference": "C8", "x": 210.82, "y": -91.44, "rotation": 0, "entry_name": "E5-13_420", "library_reference": "Capacitor_THT"},
                        {"reference": "IN0", "x": 83.82, "y": -114.3, "rotation": 0, "entry_name": "WEIDMULLER_PM5.08_2", "library_reference": "Connector_Phoenix_MSTB"},
                        {"reference": "C5", "x": 157.48, "y": -73.66, "rotation": 0, "entry_name": "C050-025X075_420", "library_reference": "Capacitor_THT"},
                        {"reference": "Q3", "x": 190.5, "y": -119.38, "rotation": 0, "entry_name": "TO126AV_400", "library_reference": "Package_TO_SOT_THT"},
                        {"reference": "R7", "x": 152.4, "y": -111.76, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "C6", "x": 152.4, "y": -124.46, "rotation": 0, "entry_name": "E3,5-8_420", "library_reference": "Capacitor_THT"},
                        {"reference": "C4", "x": 132.08, "y": -66.04, "rotation": 0, "entry_name": "E3,5-8_420", "library_reference": "Capacitor_THT"},
                        {"reference": "R4", "x": 139.7, "y": -127, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "C2", "x": 106.68, "y": -111.76, "rotation": 0, "entry_name": "E2,5-6_420", "library_reference": "Capacitor_THT"},
                        {"reference": "R2", "x": 116.84, "y": -127, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "R9", "x": 177.8, "y": -104.14, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "R6", "x": 152.4, "y": -91.44, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "S1", "x": 165.1, "y": -83.82, "rotation": 0, "entry_name": "2P2T_380", "library_reference": "Button_Switch_THT"},
                        {"reference": "R8", "x": 177.8, "y": -68.58, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"},
                        {"reference": "R3", "x": 127, "y": -101.6, "rotation": 0, "entry_name": "0204_7_420", "library_reference": "Resistor_THT"}
                    ]
                },
                footprints: [
                    {
                        properties: {"Reference": "POW0", "Value": "24V"},
                        pads: [
                            {net: {number: 11, name: "+24V"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R10", "Value": "1R_1/2W"},
                        pads: [
                            {net: {number: 1, name: "N$1"}},
                            {net: {number: 2, name: "N$2"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R1", "Value": "100K-1/4W"},
                        pads: [
                            {net: {number: 11, name: "+24V"}},
                            {net: {number: 3, name: "N$3"}}
                        ]
                    },
                    {
                        properties: {"Reference": "OUT0", "Value": "SPK"},
                        pads: [
                            {net: {number: 1, name: "N$1"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "C7", "Value": "220uf-25v"},
                        pads: [
                            {net: {number: 1, name: "N$1"}},
                            {net: {number: 2, name: "N$2"}}
                        ]
                    },
                    {
                        properties: {"Reference": "C3", "Value": "47uf-25v"},
                        pads: [
                            {net: {number: 3, name: "N$3"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "Q2", "Value": "BD439"},
                        pads: [
                            {net: {number: 4, name: "N$4"}},
                            {net: {number: 5, name: "N$5"}},
                            {net: {number: 2, name: "N$2"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R5", "Value": "1K5-1/4W"},
                        pads: [
                            {net: {number: 6, name: "N$6"}},
                            {net: {number: 7, name: "N$7"}}
                        ]
                    },
                    {
                        properties: {"Reference": "Q1", "Value": "BC560C"},
                        pads: [
                            {net: {number: 8, name: "N$8"}},
                            {net: {number: 6, name: "N$6"}},
                            {net: {number: 9, name: "N$9"}}
                        ]
                    },
                    {
                        properties: {"Reference": "C8", "Value": "1000uf-25v"},
                        pads: [
                            {net: {number: 1, name: "N$1"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "IN0", "Value": "AUDIO"},
                        pads: [
                            {net: {number: 10, name: "N$10"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "C5", "Value": "150nf-63v"},
                        pads: [
                            {net: {number: 7, name: "N$7"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "Q3", "Value": "BD439"},
                        pads: [
                            {net: {number: 13, name: "N$13"}},
                            {net: {number: 14, name: "N$14"}},
                            {net: {number: 1, name: "N$1"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R7", "Value": "100R-1/4W"},
                        pads: [
                            {net: {number: 9, name: "N$9"}},
                            {net: {number: 15, name: "N$15"}}
                        ]
                    },
                    {
                        properties: {"Reference": "C6", "Value": "220uf-25v"},
                        pads: [
                            {net: {number: 15, name: "N$15"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "C4", "Value": "100uf-35v"},
                        pads: [
                            {net: {number: 11, name: "+24V"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R4", "Value": "8K2-1/4W"},
                        pads: [
                            {net: {number: 3, name: "N$3"}},
                            {net: {number: 16, name: "N$16"}}
                        ]
                    },
                    {
                        properties: {"Reference": "C2", "Value": "10uf-63v"},
                        pads: [
                            {net: {number: 10, name: "N$10"}},
                            {net: {number: 8, name: "N$8"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R2", "Value": "12K-1/4W"},
                        pads: [
                            {net: {number: 3, name: "N$3"}},
                            {net: {number: 12, name: "GNDA"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R9", "Value": "100R-1/4W"},
                        pads: [
                            {net: {number: 2, name: "N$2"}},
                            {net: {number: 17, name: "N$17"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R6", "Value": "2K7-1/4W"},
                        pads: [
                            {net: {number: 6, name: "N$6"}},
                            {net: {number: 5, name: "N$5"}}
                        ]
                    },
                    {
                        properties: {"Reference": "S1", "Value": "2P2T"},
                        pads: [
                            {net: {number: 4, name: "N$4"}},
                            {net: {number: 7, name: "N$7"}},
                            {net: {number: 18, name: "N$18"}},
                            {net: {number: 12, name: "GNDA"}},
                            {net: {number: 5, name: "N$5"}},
                            {net: {number: 17, name: "N$17"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R8", "Value": "560R_1/2W"},
                        pads: [
                            {net: {number: 4, name: "N$4"}},
                            {net: {number: 7, name: "N$7"}}
                        ]
                    },
                    {
                        properties: {"Reference": "R3", "Value": "47K-1/4W"},
                        pads: [
                            {net: {number: 8, name: "N$8"}},
                            {net: {number: 3, name: "N$3"}}
                        ]
                    }
                ]
            };
        }

        // Function to extract component positions from PCB data
        function getComponentPositions(pcbData) {
            if (pcbData && pcbData.computed_info && pcbData.computed_info.footprint_positions) {
                return pcbData.computed_info.footprint_positions;
            } else {
                console.error('No footprint_positions data found in PCB JSON');
                return [];
            }
        }

        // Function to extract net connectivity from PCB data
        function getNetsFromPCB(pcbData) {
            if (!pcbData) return [];
            
            // Create net to components mapping
            const netToComponents = new Map();
            
            // Extract net connectivity from footprint pads
            if (pcbData.footprints) {
                for (const footprint of pcbData.footprints) {
                    let componentRef = '';
                    
                    // Get component reference
                    const properties = footprint.properties || {};
                    if (typeof properties === 'object') {
                        componentRef = properties.Reference || '';
                    }
                    
                    if (!componentRef) continue;
                    
                    // Process each pad to find net connections
                    const pads = footprint.pads || [];
                    for (const pad of pads) {
                        const netInfo = pad.net;
                        if (netInfo && netInfo.number !== undefined && netInfo.number > 0) {
                            const netNumber = netInfo.number;
                            const netName = netInfo.name || `N$${netNumber}`;
                            
                            if (!netToComponents.has(netNumber)) {
                                netToComponents.set(netNumber, {
                                    name: netName,
                                    number: netNumber,
                                    components: []
                                });
                            }
                            
                            const net = netToComponents.get(netNumber);
                            if (!net.components.includes(componentRef)) {
                                net.components.push(componentRef);
                            }
                        }
                    }
                }
            }
            
            // Convert to array format expected by netsToEdges function
            const nets = Array.from(netToComponents.values()).filter(net => net.components.length >= 2);
            
            console.log('Extracted nets from PCB:', nets);
            return nets;
        }

        // Function to extract component values from PCB data
        function getComponentValues(pcbData) {
            if (!pcbData) return {};
            
            const componentValues = {};
            
            // Extract component values from footprints
            if (pcbData.footprints) {
                for (const footprint of pcbData.footprints) {
                    let reference = '';
                    let value = '';
                    
                    // Extract reference and value from properties
                    const properties = footprint.properties || {};
                    if (typeof properties === 'object') {
                        reference = properties.Reference || '';
                        value = properties.Value || '';
                    }
                    
                    if (reference) {
                        componentValues[reference] = value;
                    }
                }
            }
            
            return componentValues;
        }

        // Function to determine component class based on footprint type and reference
        function getComponentClass(reference, entryName, description) {
            const ref = reference.toUpperCase();
            const footprint = (entryName || '').toLowerCase();
            const desc = (description || '').toLowerCase();
            
            if (ref.startsWith('R')) {
                return 'resistor';
            } else if (ref.startsWith('C')) {
                return 'capacitor';
            } else if (ref.startsWith('Q') || ref.startsWith('U')) {
                return 'transistor';
            } else if (ref.includes('GND')) {
                return 'ground';
            } else if (ref.startsWith('#P') || ref.includes('+') || ref.includes('PWR')) {
                return 'power';
            } else if (ref.startsWith('S') || footprint.includes('switch')) {
                return 'switch';
            } else if (ref.startsWith('J') || ref.startsWith('IN') || ref.startsWith('OUT') || ref.startsWith('POW') || footprint.includes('connector') || footprint.includes('weidmuller')) {
                return 'connector';
            } else {
                return 'resistor'; // default
            }
        }

        // Function to convert nets to edges
        function netsToEdges(nets) {
            const realEdges = [];
            
            for (const net of nets) {
                if (net.components && net.components.length >= 2) {
                    // Create full mesh within each net
                    for (let i = 0; i < net.components.length; i++) {
                        for (let j = i + 1; j < net.components.length; j++) {
                            realEdges.push({
                                source: net.components[i],
                                target: net.components[j]
                            });
                        }
                    }
                }
            }
            
            // Add edges with IDs
            return realEdges.map((edge, i) => ({
                id: `e${i}`,
                source: edge.source,
                target: edge.target
            }));
        }

        // Initialize edges (will be populated after loading JSON)
        graphData.edges = [];

        // Initialize Cytoscape
        let labelsVisible = true;
        let cy = null;
        
        // Function to initialize Cytoscape with loaded data
        async function initializeCytoscape() {
            // Load PCB data in a single request
            console.log('Loading PCB data...');
            const pcbData = await loadPCBData();
            
            if (!pcbData) {
                console.error('Failed to load PCB data');
                return;
            }
            
            // Extract all needed data from the loaded PCB data
            const componentPositions = getComponentPositions(pcbData);
            const componentValues = getComponentValues(pcbData);
            const nets = getNetsFromPCB(pcbData);
            
            // Build nodes from PCB component positions
            graphData.nodes = [];
            for (const position of componentPositions) {
                if (!position.reference) continue; // Skip components without references
                
                const reference = position.reference;
                const value = componentValues[reference] || '';
                const componentClass = getComponentClass(
                    reference, 
                    position.entry_name, 
                    position.library_reference
                );
                
                graphData.nodes.push({
                    id: reference,
                    label: `${reference}${value ? '\n' + value : ''}`,
                    x: position.x || 0,
                    y: position.y || 0,
                    rotation: position.rotation || 0,
                    class: componentClass,
                    footprint: position.entry_name || '',
                    library: position.library_reference || ''
                });
            }
            
            // All components should now come from PCB data only
            
            // Generate edges from nets
            graphData.edges = netsToEdges(nets);
            
            console.log('Loaded', componentPositions.length, 'component positions from PCB');
            console.log('Built', graphData.nodes.length, 'nodes total');
            console.log('Loaded', nets.length, 'nets from PCB, generated', graphData.edges.length, 'edges');
            
            cy = cytoscape({
            container: document.getElementById('cy'),
            
            elements: {
                nodes: graphData.nodes.map(node => ({
                    data: {
                        id: node.id,
                        label: node.label
                    },
                    position: {
                        x: node.x * 3,  // Scale up positions
                        y: node.y * 3
                    },
                    classes: node.class
                })),
                edges: graphData.edges.map(edge => ({
                    data: {
                        id: edge.id,
                        source: edge.source,
                        target: edge.target
                    }
                }))
            },
            
            style: [
                {
                    selector: 'node',
                    style: {
                        'background-color': '#666',
                        'label': 'data(label)',
                        'text-valign': 'center',
                        'text-halign': 'center',
                        'color': '#fff',
                        'text-outline-width': 2,
                        'text-outline-color': '#000',
                        'font-size': '11px',
                        'width': 'label',
                        'height': 'label',
                        'padding': '8px',
                        'text-wrap': 'wrap',
                        'text-max-width': '80px'
                    }
                },
                {
                    selector: '.transistor',
                    style: {
                        'background-color': '#FF6B6B',
                        'shape': 'triangle',
                        'min-width': '50px',
                        'min-height': '50px'
                    }
                },
                {
                    selector: '.resistor',
                    style: {
                        'background-color': '#FFA500',
                        'shape': 'rectangle',
                        'min-width': '60px',
                        'min-height': '30px'
                    }
                },
                {
                    selector: '.capacitor',
                    style: {
                        'background-color': '#9370DB',
                        'shape': 'ellipse',
                        'min-width': '50px',
                        'min-height': '50px'
                    }
                },
                {
                    selector: '.connector',
                    style: {
                        'background-color': '#4CAF50',
                        'shape': 'pentagon',
                        'min-width': '60px',
                        'min-height': '60px'
                    }
                },
                {
                    selector: '.power',
                    style: {
                        'background-color': '#FFD700',
                        'shape': 'star',
                        'min-width': '55px',
                        'min-height': '55px'
                    }
                },
                {
                    selector: '.ground',
                    style: {
                        'background-color': '#8B4513',
                        'shape': 'diamond',
                        'min-width': '50px',
                        'min-height': '50px'
                    }
                },
                {
                    selector: '.switch',
                    style: {
                        'background-color': '#87CEEB',
                        'shape': 'hexagon',
                        'min-width': '45px',
                        'min-height': '45px'
                    }
                },
                {
                    selector: 'edge',
                    style: {
                        'width': 2,
                        'line-color': '#666',
                        'curve-style': 'straight'
                    }
                },
                {
                    selector: ':selected',
                    style: {
                        'background-color': '#61bffc',
                        'line-color': '#61bffc',
                        'target-arrow-color': '#61bffc',
                        'source-arrow-color': '#61bffc'
                    }
                }
            ],
            
            layout: {
                name: 'preset'
            },
            
            minZoom: 0.1,
            maxZoom: 10,
            wheelSensitivity: 0.2
        });
        }

        // Toggle labels
        function toggleLabels() {
            if (!cy) return;
            labelsVisible = !labelsVisible;
            cy.style().selector('node').style({
                'label': labelsVisible ? 'data(label)' : ''
            }).update();
        }

        // Fit to screen
        function fitToScreen() {
            if (!cy) return;
            cy.fit();
        }

        // Store current physics parameters
        let currentPhysics = {
            edgeLength: 120,
            repulsion: 800,
            gravity: 5,
            damping: 0.85,
            speed: 1.0,
            repulsionRange: 150,
            gravityRange: 250
        };
        
        let animationId = null;
        let isPhysicsRunning = false;
        
        // Enhanced physics simulation with overlap prevention
        function runContinuousPhysics() {
            if (!isPhysicsRunning) return;
            
            const nodes = cy.nodes();
            const dt = 0.016 * currentPhysics.speed;
            
            // Physics with overlap prevention
            nodes.forEach(node => {
                if (node.grabbed()) return;
                
                let fx = 0, fy = 0;
                const pos = node.position();
                const bb1 = node.boundingBox();
                
                // Global repulsion from all other nodes
                nodes.forEach(other => {
                    if (node === other) return;
                    const otherPos = other.position();
                    const bb2 = other.boundingBox();
                    const dx = pos.x - otherPos.x;
                    const dy = pos.y - otherPos.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    // Minimum distance based on bounding boxes to prevent overlap
                    const minDist = Math.max((bb1.w + bb2.w) * 0.6, (bb1.h + bb2.h) * 0.6);
                    
                    if (dist < currentPhysics.repulsionRange && dist > 0) {
                        let force = currentPhysics.repulsion * 1000 / (dist * dist);
                        
                        // Extra strong repulsion if too close (overlap prevention)
                        if (dist < minDist) {
                            force *= 5;
                        }
                        
                        fx += force * dx / dist;
                        fy += force * dy / dist;
                    }
                });
                
                // Gravity attraction to connected nodes only
                const connectedNodes = node.neighborhood().nodes();
                connectedNodes.forEach(other => {
                    const otherPos = other.position();
                    const dx = otherPos.x - pos.x;
                    const dy = otherPos.y - pos.y;
                    const dist = Math.sqrt(dx * dx + dy * dy);
                    
                    if (dist < currentPhysics.gravityRange && dist > 0) {
                        const desiredDist = currentPhysics.edgeLength;
                        const springForce = (dist - desiredDist) * currentPhysics.gravity * 0.1;
                        fx += springForce * dx / dist;
                        fy += springForce * dy / dist;
                    }
                });
                
                // Update velocity and position
                let vel = node.scratch('velocity') || { x: 0, y: 0 };
                vel.x = (vel.x + fx * dt) * currentPhysics.damping;
                vel.y = (vel.y + fy * dt) * currentPhysics.damping;
                
                node.scratch('velocity', vel);
                node.position({
                    x: pos.x + vel.x * dt,
                    y: pos.y + vel.y * dt
                });
            });
            
            animationId = requestAnimationFrame(runContinuousPhysics);
        }
        
        
        // Start/stop physics simulation
        function togglePhysics(enable) {
            isPhysicsRunning = enable;
            if (enable) {
                runContinuousPhysics();
            } else if (animationId) {
                cancelAnimationFrame(animationId);
            }
        }
        
        // Update physics parameters
        function updatePhysics() {
            const edgeLength = parseInt(document.getElementById('edgeLength').value);
            const repulsion = parseInt(document.getElementById('repulsion').value);
            const gravity = parseInt(document.getElementById('gravity').value);
            const damping = parseFloat(document.getElementById('damping').value);
            const speed = parseFloat(document.getElementById('speed').value);
            const repulsionRange = parseInt(document.getElementById('repulsionRange').value);
            const gravityRange = parseInt(document.getElementById('gravityRange').value);
            
            // Update display values
            document.getElementById('edgeLengthValue').textContent = edgeLength;
            document.getElementById('repulsionValue').textContent = (repulsion / 1000) + 'k';
            document.getElementById('gravityValue').textContent = gravity;
            document.getElementById('dampingValue').textContent = damping;
            document.getElementById('speedValue').textContent = speed + 'x';
            document.getElementById('repulsionRangeValue').textContent = repulsionRange;
            document.getElementById('gravityRangeValue').textContent = gravityRange;
            
            // Update stored parameters
            currentPhysics = { 
                edgeLength, 
                repulsion: repulsion * 0.001, // Scale for continuous physics
                gravity: gravity,
                damping: damping,
                speed: speed,
                repulsionRange: repulsionRange,
                gravityRange: gravityRange
            };
        }

        // Toggle physics button
        function togglePhysicsButton() {
            const button = document.getElementById('physicsToggle');
            if (isPhysicsRunning) {
                togglePhysics(false);
                button.textContent = 'Start Physics';
                button.style.backgroundColor = '#4CAF50';
            } else {
                togglePhysics(true);
                button.textContent = 'Stop Physics';
                button.style.backgroundColor = '#f44336';
            }
        }
        
        // Initialize everything when page loads
        document.addEventListener('DOMContentLoaded', async function() {
            await initializeCytoscape();
            
            // Fit to screen on load
            cy.ready(() => {
                console.log('Cytoscape ready, nodes:', cy.nodes().length, 'edges:', cy.edges().length);
                cy.fit();
                
                // Initialize physics parameters
                currentPhysics = { 
                    edgeLength: 120, 
                    repulsion: 800, // Already scaled
                    gravity: 5,
                    damping: 0.85,
                    speed: 1.0,
                    repulsionRange: 150,
                    gravityRange: 250
                };
                
                // Auto-start physics after initial layout
                setTimeout(() => {
                    togglePhysicsButton();
                }, 1000);
                
                // Node click info
                cy.on('tap', 'node', function(evt) {
                    const node = evt.target;
                    console.log('Node clicked:', node.id(), node.data());
                });
            });
        });
        
        // Debug: Log any errors
        window.addEventListener('error', function(e) {
            console.error('JavaScript error:', e.error);
        });
    </script>
</body>
</html>