{
"name": "Master of Muppets Firmware",
"description": "USB MIDI to 16-channel CV converter firmware for Teensy 4.1",
"platform": "Teensy 4.1",
"framework": "Arduino",
"build_system": "PlatformIO",
"version": "Season 04",
"architecture": {
"overview": "Multi-threaded real-time MIDI to CV conversion system with hardware abstraction layer",
"main_components": [
"USB MIDI input handler",
"Multi-threaded DAC control system",
"Hardware abstraction layer for multiple DAC types",
"Real-time clock management",
"Thread-safe buffer management"
],
"threading_model": {
"library": "TeensyThreads",
"thread_slice": "10 microseconds",
"main_threads": [
{
"name": "the_muppet_show",
"purpose": "Main DAC update thread - copies input to output buffers"
},
{
"name": "the_voice_from_beyond",
"purpose": "MIDI input processing thread"
},
{
"name": "muppet_worker",
"purpose": "Individual DAC worker threads (one per DAC)",
"count": "2 (one per DAC)"
},
{
"name": "party_pooper",
"purpose": "Periodic force refresh thread (every 100ms)"
}
]
}
},
"directory_structure": {
"include": {
"description": "Header files",
"files": {
"dr_teeth.h": "Core configuration and buffer management",
"electric_mayhem.h": "Template-based multi-threaded DAC controller",
"muppet_clock.h": "Global timing system",
"drivers/adafruit_mcp_4728.h": "MCP4728 DAC driver interface",
"drivers/rob_tillaart_ad_5993r.h": "AD5593R DAC driver interface"
}
},
"src": {
"description": "Implementation files",
"files": {
"main.cpp": "Main application entry point and setup",
"master_of_muppets.hpp": "Global buffer instantiation",
"muppet_clock.cpp": "Clock implementation",
"drivers/adafruit_mcp_4728.cpp": "MCP4728 driver implementation",
"drivers/rob_tillaart_ad_5993r.cpp": "AD5593R driver implementation",
"name.c": "Project name/metadata"
}
},
"lib": {
"description": "Third-party libraries",
"libraries": {
"AD5593R": "Rob Tillaart's AD5593R library",
"Adafruit BusIO": "I2C/SPI abstraction layer",
"Adafruit MCP4728": "MCP4728 DAC library",
"FunctionGenerator": "LFO and waveform generation",
"TeensyThreads": "Threading library for Teensy"
}
},
"test": {
"description": "Test files",
"files": {
"README": "Test documentation"
}
}
},
"core_classes": {
"dr_teeth": {
"type": "struct",
"purpose": "Global configuration and buffer management",
"constants": {
"k_dac_count": "2 DACs",
"k_channels_per_dac": "8 channels",
"k_total_channels": "16 total channels",
"k_max_value": "65535 (16-bit)",
"k_thread_slice_micros": "10 microseconds",
"k_force_refresh_every_millis": "100 milliseconds",
"k_audio_half_scale": "32768",
"k_midi_pitch_zero_offset": "8192",
"k_midi_pitch_14_bit_max": "16383"
},
"buffers": {
"input_buffer": "16-channel input buffer from MIDI",
"output_buffer": "16-channel output buffer to DACs"
},
"methods": {
"go_muppets": "Template method to update DAC outputs"
}
},
"electric_mayhem": {
"type": "template class",
"purpose": "Multi-threaded DAC controller with thread-safe state management",
"template_parameter": "dac_driver_t (driver type)",
"key_features": [
"Thread-safe DAC state management",
"Worker threads for each DAC",
"Mutex-based synchronization",
"Sequence-based update tracking"
],
"nested_types": {
"muppet_state": "Thread-safe state for each DAC worker",
"orientation_guide": "Context passed to worker threads"
},
"methods": {
"initialize": "Initialize all DACs and start worker threads",
"attention_please": "Try to lock a DAC mutex",
"hey_you": "Lock a DAC mutex (blocking)",
"thanks": "Unlock a DAC mutex",
"throw_muppet_in_the_mud": "Request DAC update",
"shit_storm": "Force update all DACs",
"put_muppet_to_work": "Start worker thread for a DAC"
}
},
"muppet_clock": {
"type": "class",
"purpose": "Global timing system",
"features": [
"Microsecond precision timing",
"Float-based global time",
"Overflow protection at 1000 seconds"
],
"methods": {
"what_time_is_it": "Template method to get current time",
"tick": "Update global time"
}
}
},
"driver_abstraction": {
"interface": {
"description": "Common interface for all DAC drivers",
"required_types": [
"value_t: uint16_t",
"initialization_struct_t: Driver-specific init data"
],
"required_constants": [
"k_channels: Number of channels",
"k_max_val: Maximum DAC value",
"k_wire_clock: I2C clock speed"
],
"required_methods": [
"initialize()",
"enable()",
"disable()",
"set_channel_value()",
"set_all_channels_same_value()",
"set_values()"
]
},
"implementations": {
"adafruit_mcp_4728": {
"chip": "MCP4728",
"channels": 4,
"resolution": "12-bit",
"interface": "I2C",
"features": [
"LDAC pin control",
"Fast write support"
]
},
"rob_tillaart_ad_5993r": {
"chip": "AD5593R",
"channels": 8,
"resolution": "12-bit",
"interface": "I2C",
"features": [
"Configurable I/O",
"Internal reference",
"2x output range"
]
}
}
},
"configuration": {
"platformio_ini": {
"platform": "teensy",
"board": "teensy41",
"framework": "arduino",
"build_flags": [
"USB_MIDI_SERIAL",
"-O3 (max optimization)",
"-ffast-math",
"-funroll-loops",
"-fomit-frame-pointer",
"ARM Cortex-M7 specific flags"
],
"libraries": [
"Adafruit BusIO",
"Adafruit MCP4728",
"AD5593R",
"TeensyThreads",
"FunctionGenerator"
]
},
"hardware_configuration": {
"dac_0": {
"type": "AD5593R",
"i2c_bus": "Wire2",
"control_pin": 11
},
"dac_1": {
"type": "AD5593R",
"i2c_bus": "Wire1",
"control_pin": 37
}
}
},
"operational_modes": {
"normal_mode": {
"description": "USB MIDI to CV conversion",
"input": "USB MIDI pitch bend messages",
"processing": "14-bit MIDI to 16-bit conversion",
"output": "0-10V CV signals on 16 channels"
},
"test_mode": {
"description": "LFO test mode (compile-time flag)",
"defines": [
"DENTAL_CHECK",
"LFO_FREQUENCY"
],
"features": [
"Configurable LFO frequency and shape",
"LED debugging output",
"Single or all-channel LFO output"
]
}
},
"data_flow": {
"input_stage": {
"source": "USB MIDI",
"handler": "set_channel_value callback",
"conversion": "14-bit MIDI to 16-bit internal",
"buffer": "dr_teeth::input_buffer"
},
"processing_stage": {
"thread": "the_muppet_show",
"operation": "Copy input_buffer to output_buffer",
"synchronization": "Mutex-protected buffer access"
},
"output_stage": {
"threads": "muppet_worker (per DAC)",
"operation": "Write output_buffer to DAC hardware",
"conversion": "16-bit to 12-bit DAC values",
"timing": "Sequence-based update tracking"
}
},
"thread_safety": {
"mechanisms": [
"Mutex locks for buffer protection",
"Sequence numbers for update tracking",
"Thread-local buffer copies in workers",
"Atomic state flags"
],
"critical_sections": [
"Buffer copy operations",
"DAC hardware access",
"State updates"
]
},
"performance_optimizations": {
"compiler_flags": [
"Maximum optimization (-O3)",
"Fast math operations",
"Loop unrolling",
"Frame pointer omission"
],
"code_patterns": [
"Template-based polymorphism (compile-time)",
"Static buffers (no dynamic allocation)",
"Inline functions for small operations",
"Direct memory copies with memcpy"
],
"threading": [
"10 microsecond thread slices",
"Yield-based cooperative multitasking",
"Separate worker threads per DAC"
]
},
"naming_conventions": {
"theme": "Muppets characters and references",
"examples": {
"dr_teeth": "Band leader - core configuration",
"electric_mayhem": "The band - DAC controller",
"muppet_clock": "Timing system",
"the_muppet_show": "Main processing thread",
"the_voice_from_beyond": "Input thread",
"throw_muppet_in_the_mud": "Request DAC update",
"shit_storm": "Force all updates",
"party_pooper": "Periodic refresh thread"
}
},
"build_and_deployment": {
"build_command": "platformio run",
"upload_command": "platformio run --target upload",
"monitor_command": "platformio device monitor",
"clean_command": "platformio run --target clean",
"requirements": [
"PlatformIO Core",
"Teensy platform package",
"USB drivers for Teensy"
]
},
"debugging_features": {
"compile_time_flags": {
"DENTAL_CHECK": "Enable test mode",
"LFO_FREQUENCY": "Set LFO frequency for testing",
"LFO_SHAPE": "Set LFO waveform shape",
"LFO_CHANNEL": "Restrict LFO to single channel",
"DEBUG_LED": "Enable LED debugging",
"DEBUG_LED_BLINK": "Enable LED blinking",
"DEBUG_CHANNEL": "Channel to monitor on LED"
},
"runtime_monitoring": [
"LED intensity shows channel value",
"LED blinking indicates activity",
"Serial output for debugging"
]
},
"key_features": {
"real_time_performance": "10Î¼s thread slices for low latency",
"hardware_abstraction": "Template-based driver interface",
"thread_safety": "Comprehensive mutex and sequence-based synchronization",
"scalability": "Easy to add new DAC types or change channel count",
"robustness": "Retry logic for hardware initialization",
"efficiency": "Zero dynamic allocation, compile-time optimization"
}
}